<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Velocite Systems Protected Point to Point Solution: p3kprimary.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>p3kprimary.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
<h3>Protected Point to Point main primary file</h3>
<p>
Copyright (C) Velocite 2010<p>
The Velocite Systems Protected Point to Point (P3) Primary system is the master end point in a virtual point to point connection over the Internet. It listens for connections from secondary P3 systems, and when a request is accepted, establishes an IPSec encrypted session. <p>
When an encrypted Data session is established, an encrypted Control session which is tunneled through the main session is established. This is immediately used to set new encryption keys for both the Data and Control sessions. <p>
All runtime administration is performed from the primary P3 system. The user interface is interactive from the command line. 
<p>
<code>#include &quot;<a class="el" href="p3kprimary_8h-source.html">p3kprimary.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="p3kshare_8h-source.html">p3kshare.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="p3kcrypto_8h-source.html">p3kcrypto.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for p3kprimary.c:</div>
<div class="dynsection">
<p><center><img src="p3kprimary_8c__incl.png" border="0" usemap="#p3kprimary.c_map" alt=""></center>
<map name="p3kprimary.c_map">
<area shape="rect" href="p3kprimary_8h.html" title="p3kprimary.h" alt="" coords="751,84,855,111"><area shape="rect" href="p3kcrypto_8h.html" title="p3kcrypto.h" alt="" coords="849,316,945,343"><area shape="rect" href="p3kshare_8h.html" title="p3kshare.h" alt="" coords="616,161,707,188"><area shape="rect" href="p3kbase_8h.html" title="p3kbase.h" alt="" coords="737,316,825,343"><area shape="rect" href="p3knet_8h.html" title="p3knet.h" alt="" coords="781,161,859,188"><area shape="rect" href="p3linux_8h.html" title="p3linux.h" alt="" coords="800,393,877,420"><area shape="rect" href="p3ksession_8h.html" title="p3ksession.h" alt="" coords="832,239,936,265"></map>
</div>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#a7b0de3ef8b27a290ba4efcfa95b461e">_p3k_PRIMARY_C</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#1df38194b0c465f332d16d0a9055f4b5">init_primary</a> (unsigned char *ramdisk)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#15ca37bcc4730f5931238ec7bccf0ff0">parse_p3data</a> (unsigned char *buffer, int size)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#03d79b6ee63bc63762cdea330216b2d9">start_rekeying</a> (<a class="el" href="struct__p3session.html">p3session</a> *session)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="struct__p3pri__main.html">p3pri_main</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#208680be731447ccb8f72df566ed7eba">primain</a> = NULL</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">enum <a class="el" href="p3share_8h.html#e88915a16e6d96be0907b862f1786832">ioctl_cmd</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#4f6be7e5f5ccf5456ae2a964033cb8d1">iocmd</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#e992180cf3b16ba07cd8b1d87c2b1e1d">tbuf</a> [4092]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#33417e7420182dd8d4c5879d75be2f69">p3buf</a> = <a class="el" href="p3ksecondary_8c.html#e992180cf3b16ba07cd8b1d87c2b1e1d">tbuf</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct <a class="el" href="p3kprimary_8h.html#13547808d1c537d37c5d94060b8c7f90">p3config</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="p3kprimary_8c.html#81843c0551077f570eb1e45b913edc9a">config</a> = NULL</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7b0de3ef8b27a290ba4efcfa95b461e"></a><!-- doxytag: member="p3kprimary.c::_p3k_PRIMARY_C" ref="a7b0de3ef8b27a290ba4efcfa95b461e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _p3k_PRIMARY_C&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="1df38194b0c465f332d16d0a9055f4b5"></a><!-- doxytag: member="p3kprimary.c::init_primary" ref="1df38194b0c465f332d16d0a9055f4b5" args="(unsigned char *ramdisk)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int init_primary           </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>ramdisk</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl class="user" compact><dt><b>Function:</b></dt><dd>init_p3primary</dd></dl>
<dl class="user" compact><dt><b>Description:</b></dt><dd>Initialize the P3 Primary module by creating the basic structures for handling P3 primary connections.</dd></dl>
<dl class="user" compact><dt><b>Inputs:</b></dt><dd><ul>
<li>ramdisk: The location of the RAM disk area.</li></ul>
</dd></dl>
<dl class="user" compact><dt><b>Outputs:</b></dt><dd><ul>
<li>int: Status<ul>
<li>0 = OK</li><li>&lt;0 = Error </li></ul>
</li></ul>
</dd></dl>

<p>References <a class="el" href="p3kprimary_8h-source.html#l00040">_p3pri_main::array_size</a>, <a class="el" href="p3knet_8c-source.html#l00060">init_p3net()</a>, <a class="el" href="p3kprimary_8h-source.html#l00039">_p3pri_main::key_mgr</a>, <a class="el" href="p3kcrypto_8h-source.html#l00064">_p3key_mgr::key_serv</a>, <a class="el" href="p3kcrypto_8h-source.html#l00065">_p3key_mgr::lock</a>, <a class="el" href="mdefs_8h-source.html#l00019">NULL</a>, <a class="el" href="p3base_8h-source.html#l00185">p3calloc</a>, <a class="el" href="p3profile_8c-source.html#l00387">p3errmsg()</a>, <a class="el" href="p3linux_8h-source.html#l00069">p3lock_init</a>, <a class="el" href="p3base_8h-source.html#l00046">p3MSG_CRIT</a>, <a class="el" href="p3share_8h-source.html#l00058">p3PRI_PORT</a>, <a class="el" href="p3kprimary_8h-source.html#l00041">p3RMT_ARSZ</a>, and <a class="el" href="p3kprimary_8h-source.html#l00047">_p3pri_main::port</a>.</p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="p3kprimary_8c_1df38194b0c465f332d16d0a9055f4b5_cgraph.png" border="0" usemap="#p3kprimary_8c_1df38194b0c465f332d16d0a9055f4b5_cgraph_map" alt=""></center>
<map name="p3kprimary_8c_1df38194b0c465f332d16d0a9055f4b5_cgraph_map">
<area shape="rect" href="p3knet_8c.html#ebcb19f32b96fdb0c580e57088828b4a" title="init_p3net" alt="" coords="151,5,233,32"><area shape="rect" href="p3profile_8c.html#115044c21fee0be99499431a0d3cabdc" title="p3errmsg" alt="" coords="284,31,367,57"></map>
</div>

</div>
</div><p>
<a class="anchor" name="15ca37bcc4730f5931238ec7bccf0ff0"></a><!-- doxytag: member="p3kprimary.c::parse_p3data" ref="15ca37bcc4730f5931238ec7bccf0ff0" args="(unsigned char *buffer, int size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int parse_p3data           </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl class="user" compact><dt><b>Function:</b></dt><dd>parse_p3data</dd></dl>
<dl class="user" compact><dt><b>Description:</b></dt><dd>Parse data sent from the P3 user space application in an ioctl command.</dd></dl>
<dl class="user" compact><dt><b>Inputs:</b></dt><dd><ul>
<li>buffer: The data to be parsed</li><li>size: The size of the data buffer</li></ul>
</dd></dl>
<dl class="user" compact><dt><b>Outputs:</b></dt><dd><ul>
<li>int: Status<ul>
<li>0 = OK</li><li>&lt;0 = Critical error</li><li>&gt;0 = Non-critical error </li></ul>
</li></ul>
</dd></dl>

</div>
</div><p>
<a class="anchor" name="03d79b6ee63bc63762cdea330216b2d9"></a><!-- doxytag: member="p3kprimary.c::start_rekeying" ref="03d79b6ee63bc63762cdea330216b2d9" args="(p3session *session)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void start_rekeying           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct__p3session.html">p3session</a> *&nbsp;</td>
          <td class="paramname"> <em>session</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl class="user" compact><dt><b>Function:</b></dt><dd>start_rekeying</dd></dl>
<dl class="user" compact><dt><b>Description:</b></dt><dd>Start the rekeying control sequence</dd></dl>
<dl class="user" compact><dt><b>Inputs:</b></dt><dd><ul>
<li>p3sess: The remote P3 host session information</li></ul>
</dd></dl>
<dl class="user" compact><dt><b>Outputs:</b></dt><dd><ul>
<li>int: Status<ul>
<li>0 = OK</li><li>&lt;0 = Critical error</li><li>&gt;0 = Non-critical error </li></ul>
</li></ul>
</dd></dl>

<p>References <a class="el" href="p3ksession_8h.html#82ba0db0ef7ddf7e28cc28fab0761aa3">build_newkey_message()</a>, <a class="el" href="p3ksession_8h-source.html#l00141">_p3session::flag</a>, <a class="el" href="p3kprimary_8h-source.html#l00039">_p3pri_main::key_mgr</a>, <a class="el" href="p3ksession_8h-source.html#l00124">_p3session::lock</a>, <a class="el" href="mdefs_8h-source.html#l00019">NULL</a>, <a class="el" href="p3linux_8h-source.html#l00072">p3lock</a>, <a class="el" href="p3ksession_8h-source.html#l00144">p3PSS_REKEY</a>, <a class="el" href="p3knet_8c-source.html#l00733">p3send_control()</a>, and <a class="el" href="p3linux_8h-source.html#l00075">p3unlock</a>.</p>

<p>Referenced by <a class="el" href="p3knet_8c-source.html#l00198">packet_handler()</a>.</p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="p3kprimary_8c_03d79b6ee63bc63762cdea330216b2d9_cgraph.png" border="0" usemap="#p3kprimary_8c_03d79b6ee63bc63762cdea330216b2d9_cgraph_map" alt=""></center>
<map name="p3kprimary_8c_03d79b6ee63bc63762cdea330216b2d9_cgraph_map">
<area shape="rect" href="p3ksession_8h.html#82ba0db0ef7ddf7e28cc28fab0761aa3" title="build_newkey_message" alt="" coords="167,5,337,32"><area shape="rect" href="p3knet_8c.html#e42b8ad940d0e2e7f53e7e4096934645" title="p3send_control" alt="" coords="192,56,312,83"><area shape="rect" href="p3kcrypto_8c.html#e807e42de382b4967dcf61a94abf1d63" title="p3_encrypt" alt="" coords="388,56,479,83"><area shape="rect" href="p3profile_8c.html#115044c21fee0be99499431a0d3cabdc" title="p3errmsg" alt="" coords="993,132,1076,159"><area shape="rect" href="p3linux_8c.html#61e0f4c4c3ee65ef0c0c47c5766d25fc" title="p3net_utils" alt="" coords="388,107,479,133"><area shape="rect" href="aes_8c.html#0773743fae8155fec8bf75c087531364" title="DoAES" alt="" coords="591,157,655,184"><area shape="rect" href="merrors_8c.html#e0fbf1c8cf3bc5beb2c222ef6fb403e2" title="MERROR_lookUpErrorCode" alt="" coords="528,31,717,57"><area shape="rect" href="aes_8h.html#b00b50ef06bf8b54ce973618804586e2" title="AESALGO_blockDecrypt" alt="" coords="765,233,939,260"><area shape="rect" href="aes_8h.html#5c1fa1647ea06de25b72db0239129de6" title="AESALGO_blockEncrypt" alt="" coords="767,183,937,209"><area shape="rect" href="aesalgo_8c.html#4c719df4534cebdf4a32e36b2baeeaf8" title="aesDecrypt" alt="" coords="988,233,1081,260"><area shape="rect" href="aesalgo_8c.html#ab1010e729d5c019e6ef9e4dd55a3b96" title="aesEncrypt" alt="" coords="989,183,1080,209"></map>
</div>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="208680be731447ccb8f72df566ed7eba"></a><!-- doxytag: member="p3kprimary.c::primain" ref="208680be731447ccb8f72df566ed7eba" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct__p3pri__main.html">p3pri_main</a>* <a class="el" href="p3kprimaryplus_8h.html#208680be731447ccb8f72df566ed7eba">primain</a> = NULL          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
The main primary structure 
</div>
</div><p>
<a class="anchor" name="4f6be7e5f5ccf5456ae2a964033cb8d1"></a><!-- doxytag: member="p3kprimary.c::iocmd" ref="4f6be7e5f5ccf5456ae2a964033cb8d1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="p3share_8h.html#e88915a16e6d96be0907b862f1786832">ioctl_cmd</a> <a class="el" href="p3kshare_8h.html#4f6be7e5f5ccf5456ae2a964033cb8d1">iocmd</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
ioctl_cmd defines the format of the ioctl data passed between the user and kernel space where the command meanings are:<ul>
<li>noop: Unused</li><li>primarycfg: Configuration data for a P3 primary system</li><li>secondarycfg: Configuration data for a P3 secondary system</li><li>prihostcfg: Configuration data for a remote P3 primary system</li><li>sechostcfg: Configuration data for a remote P3 secondary system</li><li>newsession: Data for starting a new P3 session </li></ul>

</div>
</div><p>
<a class="anchor" name="e992180cf3b16ba07cd8b1d87c2b1e1d"></a><!-- doxytag: member="p3kprimary.c::tbuf" ref="e992180cf3b16ba07cd8b1d87c2b1e1d" args="[4092]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="p3ksecondary_8c.html#e992180cf3b16ba07cd8b1d87c2b1e1d">tbuf</a>[4092]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Working buffer 
</div>
</div><p>
<a class="anchor" name="33417e7420182dd8d4c5879d75be2f69"></a><!-- doxytag: member="p3kprimary.c::p3buf" ref="33417e7420182dd8d4c5879d75be2f69" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char * <a class="el" href="p3ksecondary_8c.html#33417e7420182dd8d4c5879d75be2f69">p3buf</a> = <a class="el" href="p3ksecondary_8c.html#e992180cf3b16ba07cd8b1d87c2b1e1d">tbuf</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="81843c0551077f570eb1e45b913edc9a"></a><!-- doxytag: member="p3kprimary.c::config" ref="81843c0551077f570eb1e45b913edc9a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="p3kprimary_8h.html#13547808d1c537d37c5d94060b8c7f90">p3config</a>* <a class="el" href="p3kprimary_8c.html#81843c0551077f570eb1e45b913edc9a">config</a> = NULL          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Sep 24 10:44:29 2010 for Velocite Systems Protected Point to Point Solution by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
